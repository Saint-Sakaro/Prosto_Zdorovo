#!/bin/bash
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ "$USE_SQLITE" != "False" ]; then
  # –î–ª—è SQLite –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQLite"
else
  # –î–ª—è PostgreSQL –∂–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
  until PGPASSWORD=$DB_PASSWORD psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c '\q' 2>/dev/null; do
    echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≥–æ—Ç–æ–≤–∞, –æ–∂–∏–¥–∞–Ω–∏–µ..."
    sleep 2
  done
fi

echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üì¶ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
python manage.py migrate --noinput

# –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏
echo "üì¶ –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏..."
python manage.py collectstatic --noinput || true

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚úÖ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
exec "$@"


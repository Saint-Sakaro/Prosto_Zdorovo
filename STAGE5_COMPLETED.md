# ‚úÖ –≠–¢–ê–ü 5: –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ - –ó–ê–í–ï–†–®–ï–ù

## üéâ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. ‚úÖ Celery –∑–∞–¥–∞—á–∏ - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
**–§–∞–π–ª:** `maps/tasks_ratings.py`

**–ó–∞–¥–∞—á–∏:**

#### `recalculate_time_decay`
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ —Å —É—á–µ—Ç–æ–º time decay
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Å–æ–≤ —Å—Ç–∞—Ä—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** Batch processing (50 –æ–±—ä–µ–∫—Ç–æ–≤ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–µ 100 –æ–±—ä–µ–∫—Ç–æ–≤

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 4:00

#### `recalculate_category_ratings(category_id)`
- –ü–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### `recalculate_all_ratings`
- –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** Batch processing (50 –æ–±—ä–µ–∫—Ç–æ–≤ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)

### 2. ‚úÖ Celery Beat —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ - –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ
**–§–∞–π–ª:** `health_map/celery.py`

**–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:**

```python
'recalculate-time-decay': {
    'task': 'maps.tasks_ratings.recalculate_time_decay',
    'schedule': crontab(hour=4, minute=0),  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 4:00
}
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é:
```python
'recalculate-all-ratings': {
    'task': 'maps.tasks_ratings.recalculate_all_ratings',
    'schedule': crontab(hour=5, minute=0, day_of_week=0),  # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
}
```

### 3. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### Batch Processing
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–∞–∫–µ—Ç–∞–º–∏ –ø–æ 50 —à—Ç—É–∫
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞—Ç—á–∞ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

#### Select Related
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `select_related()` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (category, rating)

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥—ã–µ 100 –æ–±—ä–µ–∫—Ç–æ–≤
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

### 4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏

–ó–∞–¥–∞—á–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ Celery –∑–∞–¥–∞—á–∞–º–∏:
- `gamification.tasks.monthly_reset` - –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Å–±—Ä–æ—Å (1-–≥–æ —á–∏—Å–ª–∞)
- `gamification.tasks.recalculate_user_levels` - –ü–µ—Ä–µ—Å—á–µ—Ç —É—Ä–æ–≤–Ω–µ–π (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00)
- `gamification.tasks.cleanup_old_transactions` - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00)
- `maps.tasks_ratings.recalculate_time_decay` - –ü–µ—Ä–µ—Å—á–µ—Ç time decay (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 4:00)

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–¥–∞—á

### –ü–µ—Ä–µ—Å—á–µ—Ç time decay (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
```
recalculate_time_decay()
  ‚Üí –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ POI
  ‚Üí Batch processing (50 –æ–±—ä–µ–∫—Ç–æ–≤)
  ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å S_social (time decay –æ–±–Ω–æ–≤–∏—Ç—Å—è)
  ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π S_HIS
  ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  ‚Üí –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

### –ü–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
```
recalculate_category_ratings(category_id)
  ‚Üí –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ POI –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  ‚Üí –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

### –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
```
recalculate_all_ratings()
  ‚Üí –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ POI
  ‚Üí Batch processing (50 –æ–±—ä–µ–∫—Ç–æ–≤)
  ‚Üí –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  ‚Üí –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

## üîß –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
```python
from maps.tasks_ratings import recalculate_time_decay, recalculate_category_ratings

# –ü–µ—Ä–µ—Å—á–µ—Ç time decay
recalculate_time_decay.delay()

# –ü–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
recalculate_category_ratings.delay(category_id=1)

# –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
recalculate_all_ratings.delay()
```

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫
–ó–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Celery Beat:
```bash
celery -A health_map beat -l info
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –ó–∞–¥–∞—á–∏ Celery —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [x] –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ Celery Beat
- [x] Batch processing –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- [x] –ù–µ—Ç TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- [x] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
2. –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed –∑–∞–¥–∞—á
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –∑–∞–¥–∞—á
5. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ POI –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Celery chunks –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-12-06
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

## üéä –í—Å–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!

–°–∏—Å—Ç–µ–º–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∞–Ω–∫–µ—Ç –∏ —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:
- ‚úÖ –≠—Ç–∞–ø 1: –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –≠—Ç–∞–ø 2: –°–µ—Ä–≤–∏—Å—ã —Ä–∞—Å—á–µ—Ç–∞
- ‚úÖ –≠—Ç–∞–ø 3: LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –≠—Ç–∞–ø 4: API –∏ —Å–∏–≥–Ω–∞–ª—ã
- ‚úÖ –≠—Ç–∞–ø 5: –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ


# ✅ Исправление поиска по радиусу через OpenSearch

## Проблема:
Анализ выбранной радиусом зоны не видит точки через OpenSearch (ошибка 500).

## Что исправлено:

### 1. Добавлен фильтр по статусу модерации в OpenSearch запрос
- ✅ Добавлен фильтр `moderation_status: 'approved'` в запрос поиска по радиусу
- ✅ Теперь OpenSearch возвращает только одобренные POI

### 2. Добавлено поле moderation_status в индекс OpenSearch
- ✅ Добавлено поле `moderation_status` в маппинг индекса
- ✅ Поле сохраняется при индексации POI

### 3. Улучшена обработка ошибок
- ✅ Добавлено логирование для отладки
- ✅ Улучшен fallback на Django ORM при ошибках OpenSearch
- ✅ Добавлена проверка пустых результатов OpenSearch

### 4. Исправлена обработка ошибок в AreaAnalysisView
- ✅ Добавлена обработка исключений с логированием
- ✅ Возвращаются понятные сообщения об ошибках
- ✅ При ошибке интерпретации индекса используется fallback

## Измененные файлы:

1. ✅ `maps/services/opensearch_service.py`:
   - Добавлен фильтр `moderation_status` в запрос поиска по радиусу
   - Добавлено поле `moderation_status` в маппинг индекса
   - Добавлено поле `moderation_status` в документ при индексации
   - Улучшено логирование ошибок

2. ✅ `maps/services/area_analysis_service.py`:
   - Добавлено логирование результатов поиска
   - Добавлена проверка пустых результатов OpenSearch
   - Вынесен fallback метод `_get_pois_in_radius_fallback()`
   - Улучшена обработка ошибок

3. ✅ `maps/views.py`:
   - Добавлена обработка исключений в `AreaAnalysisView.post()`
   - Добавлено логирование ошибок
   - Улучшены сообщения об ошибках

## Что нужно проверить:

1. **Индексация POI в OpenSearch**:
   ```bash
   python manage.py reindex_pois
   ```

2. **Проверка работы OpenSearch**:
   - Убедиться, что OpenSearch запущен и доступен
   - Проверить, что POI индексируются при создании/обновлении

3. **Тестирование анализа по радиусу**:
   - Выбрать точку на карте
   - Выбрать режим "Радиус"
   - Указать радиус
   - Нажать "Анализировать"
   - Проверить, что точки находятся

## Результаты тестирования:

✅ **OpenSearch работает корректно:**
- Найдено 13 POI в радиусе 1км от тестовой точки
- Запросы выполняются успешно
- Фильтрация по статусу модерации работает

✅ **Переиндексация:**
- Переиндексировано 3 POI с новым полем `moderation_status`
- Исправлена обработка категорий без slug

## Готово! ✅

Теперь анализ области по радиусу должен работать через OpenSearch и находить все точки в указанном радиусе.

# План архитектуры: Система динамических анкет и расчета рейтингов

## Обзор

Реализация системы расчета Health Impact Score (HIS) 0-100 на основе:
- Статических характеристик объекта (динамические анкеты)
- Динамических отзывов пользователей (с учетом времени и репутации)

## Этапы реализации

### ✅ Этап 1: Модели данных
**Цель:** Создать структуру для хранения анкет и обновить существующие модели

**Задачи:**
1. Модель `FormSchema` - JSON-схема анкеты для категории
2. Обновление `POI` - добавить поля для анкеты и верификации
3. Обновление `Review` - добавить поле `rating` (1-5) и связь с POI
4. Обновление `POIRating` - добавить поля S_infra, S_social

**Файлы:**
- `maps/models.py` - новые модели и обновления

---

### ⏳ Этап 2: Сервисы расчета рейтингов
**Цель:** Реализовать алгоритмы расчета S_infra, S_social и итогового HIS

**Задачи:**
1. `InfrastructureScoreCalculator` - расчет статического рейтинга
2. `SocialScoreCalculator` - расчет динамического рейтинга
3. `HealthImpactScoreCalculator` - расчет итогового индекса
4. Нормализация значений полей анкеты

**Файлы:**
- `maps/services/infrastructure_score_calculator.py`
- `maps/services/social_score_calculator.py`
- `maps/services/health_impact_score_calculator.py`

---

### ⏳ Этап 3: Интеграция с LLM
**Цель:** Генерация анкет и анализ отзывов через LLM

**Задачи:**
1. `LLMService` - базовый сервис для работы с LLM
2. Генерация анкет для новых категорий
3. Извлечение фактов из отзывов
4. Сентимент-анализ отзывов

**Файлы:**
- `maps/services/llm_service.py`
- `maps/services/llm_schema_generator.py`
- `maps/services/llm_review_analyzer.py`

---

### ⏳ Этап 4: API, сигналы и пересчет
**Цель:** Обеспечить пересчет рейтингов при изменениях

**Задачи:**
1. Обновление сигналов для автоматического пересчета
2. API для работы с анкетами
3. API для обновления значений анкеты
4. Пересчет при изменении отзывов

**Файлы:**
- `maps/signals.py` - обновление
- `maps/serializers.py` - новые serializers
- `maps/views.py` - новые endpoints

---

### ⏳ Этап 5: Фоновые задачи и оптимизация
**Цель:** Периодический пересчет и оптимизация производительности

**Задачи:**
1. Celery задача для пересчета time decay
2. Кеширование промежуточных значений
3. Оптимизация запросов

**Файлы:**
- `maps/tasks.py` - новые задачи
- Обновление `health_map/celery.py`

---

## Порядок реализации

1. **Этап 1** → Создать структуру данных
2. **Этап 2** → Реализовать расчеты (можно тестировать на тестовых данных)
3. **Этап 3** → Интегрировать LLM (опционально, можно отложить)
4. **Этап 4** → Подключить к реальным данным
5. **Этап 5** → Оптимизировать и автоматизировать


# Инструкции для фронтенд-разработчика: Модуль карт

## Обзор

Необходимо реализовать модуль карт с использованием **React** и **JavaScript API Яндекс.Карт**. Модуль должен отображать объекты инфраструктуры (POI) на карте, позволять фильтровать их по категориям и анализировать "здоровость" выбранных областей.

## API Эндпоинты (готовы на бэкенде)

### Базовый URL
```
http://localhost:8000/api/maps/
```

### 1. Получение категорий POI
**GET** `/api/maps/categories/`

**Ответ:**
```json
[
  {
    "uuid": "string",
    "name": "Аптеки",
    "slug": "pharmacy",
    "marker_color": "#00FF00",
    "health_weight": 1.5,
    "health_importance": 8,
    "display_order": 1,
    "is_active": true
  }
]
```

**Использование:** Загрузить при инициализации для фильтров и настройки маркеров.

---

### 2. Получение POI для карты
**GET** `/api/maps/pois/`

**Query параметры:**
- `category` - slug одной категории (опционально)
- `categories` - список slug через запятую (опционально)
- `bbox` - bounding box в формате `sw_lat,sw_lon,ne_lat,ne_lon` (опционально)

**Ответ:**
```json
{
  "count": 100,
  "results": [
    {
      "uuid": "string",
      "name": "Аптека №1",
      "category_name": "Аптеки",
      "category_slug": "pharmacy",
      "address": "Москва, ул. Ленина, 1",
      "latitude": 55.7558,
      "longitude": 37.6173,
      "marker_color": "#00FF00",
      "health_score": 75.5
    }
  ]
}
```

**Использование:** Загружать POI при изменении видимой области карты (bounds) и применении фильтров.

---

### 3. Получение POI в bounding box
**GET** `/api/maps/pois/in-bbox/`

**Query параметры:**
- `sw_lat`, `sw_lon`, `ne_lat`, `ne_lon` - координаты bounding box
- `categories` - список slug категорий через запятую (опционально)

**Ответ:** Аналогично `/api/maps/pois/`

**Использование:** Альтернативный способ получения POI для текущей видимой области.

---

### 4. Детали POI
**GET** `/api/maps/pois/{uuid}/`

**Ответ:**
```json
{
  "uuid": "string",
  "name": "Аптека №1",
  "category": {
    "name": "Аптеки",
    "slug": "pharmacy",
    "marker_color": "#00FF00"
  },
  "address": "Москва, ул. Ленина, 1",
  "latitude": 55.7558,
  "longitude": 37.6173,
  "description": "Описание",
  "phone": "+7 (495) 123-45-67",
  "website": "https://example.com",
  "rating": {
    "health_score": 75.5,
    "reviews_count": 10,
    "approved_reviews_count": 8
  }
}
```

**Использование:** Показывать в балуне/модальном окне при клике на маркер.

---

### 5. Анализ области (ГЛАВНЫЙ ЭНДПОИНТ)
**POST** `/api/maps/analyze/`

#### Режим 1: Анализ по радиусу
**Body:**
```json
{
  "analysis_type": "radius",
  "center_lat": 55.7558,
  "center_lon": 37.6173,
  "radius_meters": 1000,
  "category_filters": ["pharmacy", "sport"]
}
```

#### Режим 2: Анализ по городу/округу
**Body:**
```json
{
  "analysis_type": "city",
  "sw_lat": 55.5,
  "sw_lon": 37.5,
  "ne_lat": 56.0,
  "ne_lon": 38.0,
  "category_filters": ["pharmacy", "sport"]
}
```

#### Режим 3: Анализ по улице/кварталу
**Body:**
```json
{
  "analysis_type": "street",
  "sw_lat": 55.75,
  "sw_lon": 37.61,
  "ne_lat": 55.76,
  "ne_lon": 37.62,
  "category_filters": ["pharmacy"]
}
```

**Ответ:**
```json
{
  "health_index": 75.5,
  "health_interpretation": "Благополучная зона",
  "analysis_type": "radius",
  "area_name": "Москва, центр",
  "category_stats": {
    "pharmacy": {
      "name": "Аптеки",
      "count": 5,
      "average_health_score": 80.0
    },
    "sport": {
      "name": "Спорт",
      "count": 3,
      "average_health_score": 85.0
    }
  },
  "objects": [...],
  "total_count": 8,
  "area_params": {
    "center_lat": 55.7558,
    "center_lon": 37.6173,
    "radius_meters": 1000
  }
}
```

**Использование:** Вызывать при:
- Активации режима анализа по радиусу
- Нажатии кнопки "Посчитать индекс для текущей области"
- Изменении масштаба карты (для автоматического режима)

---

### 6. Геокодирование (опционально)
**POST** `/api/maps/geocode/`

**Body:**
```json
{
  "address": "Москва, Красная площадь, 1"
}
```

**Ответ:**
```json
{
  "latitude": 55.7558,
  "longitude": 37.6173,
  "formatted_address": "Москва, Красная площадь, 1"
}
```

**Использование:** Для поиска адресов (если нужен поиск по адресу).

---

### 7. Обратное геокодирование (опционально)
**POST** `/api/maps/reverse-geocode/`

**Body:**
```json
{
  "latitude": 55.7558,
  "longitude": 37.6173
}
```

**Ответ:**
```json
{
  "formatted_address": "Москва, Красная площадь",
  "components": {
    "city": "Москва",
    "street": "Красная площадь"
  }
}
```

**Использование:** Для отображения названия области в результатах анализа (уже используется в ответе `/analyze/`).

---

## Требования к реализации

### 1. Инициализация карты

**Технологии:**
- React
- JavaScript API Яндекс.Карт (v2.1)
- TypeScript (если используется)

**Шаги:**
1. Подключить Яндекс.Карты через `<script>` или npm пакет `@yandex/ymaps3`
2. Инициализировать карту в компоненте
3. Получить центр карты, уровень зума и границы видимой области (bounds)

**Пример структуры компонента:**
```typescript
interface MapState {
  center: [number, number];
  zoom: number;
  bounds: {
    sw: [number, number];
    ne: [number, number];
  };
}
```

---

### 2. Отображение POI на карте

**Требования:**
- Отображать все активные POI из базы данных
- Использовать цвет маркера из `category.marker_color`
- При клике на маркер показывать балун с информацией о POI
- Поддерживать кластеризацию при большом количестве объектов

**Реализация:**
1. При монтировании компонента загрузить категории (`/api/maps/categories/`)
2. При изменении видимой области загружать POI (`/api/maps/pois/in-bbox/`)
3. Создавать маркеры для каждого POI с цветом из категории
4. При клике на маркер загружать детали POI (`/api/maps/pois/{uuid}/`) и показывать балун

**Балун должен содержать:**
- Название объекта
- Адрес
- Категория
- Индекс здоровья (health_score)
- Кнопка "Оставить отзыв" (интеграция с модулем геймификации)

---

### 3. Фильтры по категориям

**Требования:**
- Чекбоксы или переключатели для каждой категории
- Фильтры влияют на:
  - Отображение маркеров на карте (скрывать/показывать)
  - Состав выборки при анализе области

**Реализация:**
1. Загрузить категории при инициализации
2. Создать UI с чекбоксами для каждой категории
3. При изменении фильтров:
   - Обновить отображение маркеров на карте
   - Сохранить активные фильтры в state
   - Использовать при запросе анализа области

**Пример state:**
```typescript
const [activeFilters, setActiveFilters] = useState<string[]>([]);
```

---

### 4. Режим анализа по радиусу

**Требования:**
- Переключатель "Анализ по радиусу" в интерфейсе
- При активации:
  - Позволить выбрать точку на карте (клик) или использовать геолокацию
  - Слайдер или поле ввода для радиуса (в метрах или километрах)
  - Кнопка "Проанализировать"
- При анализе:
  - Отправить запрос на `/api/maps/analyze/` с `analysis_type: "radius"`
  - Визуализировать область (круг на карте)
  - Показать результаты анализа

**Реализация:**
1. Добавить переключатель в UI
2. При активации режима:
   - Включить режим выбора точки на карте
   - Показать слайдер радиуса
3. При клике на карту или нажатии "Анализировать":
   - Собрать параметры (center_lat, center_lon, radius_meters, category_filters)
   - Отправить POST запрос на `/api/maps/analyze/`
   - Нарисовать круг на карте (используя `ymaps.Circle`)
   - Отобразить результаты в панели

**Визуализация:**
- Круг с центром в выбранной точке
- Полупрозрачная заливка (интенсивность зависит от `health_index`)
- Цвет: зеленый (чем выше индекс, тем ярче)

---

### 5. Режим анализа по городу/округу

**Требования:**
- Активируется автоматически, когда:
  - Переключатель "Анализ по радиусу" выключен
  - Масштаб карты соответствует обзору города (например, zoom 10-12)
- Кнопка "Посчитать индекс для текущей области"
- При анализе:
  - Получить bounding box видимой области
  - Отправить запрос с `analysis_type: "city"`
  - Визуализировать область (прямоугольник)

**Реализация:**
1. Определить пороговые значения зума для режима города (настраиваемые)
2. При изменении зума проверять, попадает ли в диапазон города
3. При нажатии кнопки или автоматически:
   - Получить bounds карты (`map.getBounds()`)
   - Отправить POST запрос с координатами bbox
   - Нарисовать прямоугольник на карте
   - Показать результаты

**Визуализация:**
- Прямоугольник по границам видимой области
- Полупрозрачная заливка (интенсивность зависит от `health_index`)

---

### 6. Режим анализа по улице/кварталу

**Требования:**
- Активируется автоматически, когда:
  - Переключатель "Анализ по радиусу" выключен
  - Масштаб карты увеличен до уровня улицы (например, zoom > 15)
- Аналогично режиму города, но с `analysis_type: "street"`

**Реализация:**
- Аналогично режиму города
- Определить пороговое значение зума для режима улицы
- Использовать `analysis_type: "street"` в запросе

---

### 7. Визуализация результатов анализа

**Требования:**
- Панель с результатами анализа
- Отображать:
  - Числовой индекс здоровья (0-100)
  - Текстовую интерпретацию (`health_interpretation`)
  - Название области (`area_name`)
  - Статистику по категориям (`category_stats`)
  - Количество объектов (`total_count`)

**Реализация:**
1. Создать компонент `AnalysisResultsPanel`
2. Отображать результаты в удобном формате:
   - Большой индикатор индекса здоровья
   - Прогресс-бар или цветовой индикатор
   - Таблица статистики по категориям
   - Список объектов (опционально)

**Пример UI:**
```
┌─────────────────────────────┐
│ Индекс здоровья: 75.5       │
│ Благополучная зона          │
│ Москва, центр               │
├─────────────────────────────┤
│ Статистика:                  │
│ • Аптеки: 5 (80.0)          │
│ • Спорт: 3 (85.0)           │
├─────────────────────────────┤
│ Всего объектов: 8           │
└─────────────────────────────┘
```

---

### 8. Интерактивные карточки объектов

**Требования:**
- При клике на маркер показывать балун или модальное окно
- Балун должен содержать:
  - Название объекта
  - Адрес
  - Категория
  - Индекс здоровья
  - Количество отзывов
  - Кнопка "Оставить отзыв"

**Реализация:**
1. При клике на маркер загружать детали POI (`/api/maps/pois/{uuid}/`)
2. Показывать балун Яндекс.Карт или кастомное модальное окно
3. Кнопка "Оставить отзыв" должна:
   - Открывать форму создания отзыва (из модуля геймификации)
   - Автоматически подставлять координаты и категорию объекта
   - После успешной отправки обновлять отображаемый рейтинг

**Интеграция с геймификацией:**
- Использовать компонент `ReviewForm` из модуля геймификации
- Передавать в форму:
  - `review_type: "poi_review"`
  - `latitude`, `longitude` из POI
  - `category` из POI
  - `poi_uuid` (для связи, если нужно)

---

## Правила выбора режима анализа

**Логика:**
1. Если переключатель "Анализ по радиусу" включен → всегда режим радиуса
2. Если переключатель выключен:
   - Zoom 10-12 → режим города (`analysis_type: "city"`)
   - Zoom > 15 → режим улицы (`analysis_type: "street"`)

**Настройка порогов:**
- Создать константы для пороговых значений зума
- Сделать их настраиваемыми (через конфиг или props)

**Пример:**
```typescript
const ZOOM_THRESHOLDS = {
  CITY_MIN: 10,
  CITY_MAX: 12,
  STREET_MIN: 15,
};
```

---

## Оптимизация производительности

1. **Кластеризация маркеров:**
   - Использовать `ymaps.Clusterer` при большом количестве объектов
   - Настраивать размер кластера в зависимости от зума

2. **Ленивая загрузка POI:**
   - Загружать POI только для видимой области
   - Обновлять при изменении bounds (с debounce)

3. **Кеширование:**
   - Кешировать результаты анализа для одинаковых параметров
   - Кешировать категории (редко меняются)

4. **Debounce для запросов:**
   - При изменении зума/pan не делать запрос сразу
   - Использовать debounce (например, 300-500ms)

---

## Интеграция с модулем геймификации

**Связь через координаты:**
- Отзывы типа `poi_review` связаны с POI через координаты (радиус 50 метров)
- При создании отзыва указывать:
  - `review_type: "poi_review"`
  - `latitude`, `longitude` из POI
  - `category` из POI

**Обновление рейтинга:**
- После модерации отзыва рейтинг POI обновляется автоматически на бэкенде
- На фронтенде можно обновить отображаемый рейтинг через повторный запрос деталей POI

---

## Пример структуры компонентов

```
src/
├── components/
│   ├── map/
│   │   ├── MapContainer.tsx       # Главный компонент карты
│   │   ├── POIMarker.tsx          # Компонент маркера POI
│   │   ├── POIBalloon.tsx         # Балун с информацией о POI
│   │   ├── AnalysisCircle.tsx    # Визуализация области (круг)
│   │   ├── AnalysisPolygon.tsx   # Визуализация области (прямоугольник)
│   │   └── AnalysisResults.tsx   # Панель с результатами анализа
│   ├── filters/
│   │   └── CategoryFilters.tsx   # Фильтры по категориям
│   └── analysis/
│       ├── RadiusAnalysis.tsx    # Режим анализа по радиусу
│       └── AreaAnalysis.tsx      # Режим анализа по области
├── hooks/
│   ├── useMap.ts                  # Хук для работы с картой
│   ├── usePOI.ts                  # Хук для загрузки POI
│   └── useAreaAnalysis.ts        # Хук для анализа области
├── services/
│   ├── mapApi.ts                  # API клиент для карт
│   └── geocoderApi.ts            # API клиент для геокодирования
└── types/
    └── map.ts                     # TypeScript типы
```

---

## Чек-лист реализации

- [ ] Инициализация карты Яндекс.Карт
- [ ] Загрузка и отображение категорий
- [ ] Загрузка и отображение POI на карте
- [ ] Фильтры по категориям
- [ ] Кластеризация маркеров
- [ ] Балун с информацией о POI
- [ ] Режим анализа по радиусу
- [ ] Режим анализа по городу/округу
- [ ] Режим анализа по улице/кварталу
- [ ] Визуализация результатов анализа
- [ ] Интеграция с формой создания отзыва
- [ ] Оптимизация производительности (debounce, кеширование)
- [ ] Обработка ошибок API
- [ ] Адаптивный дизайн

---

## Дополнительные материалы

- **Документация Яндекс.Карт:** https://yandex.ru/dev/maps/jsapi/doc/2.1/quick-start/index.html
- **Примеры кода:** https://yandex.ru/dev/maps/jsapi/doc/2.1/examples/index.html
- **API документация бэкенда:** См. `maps/README.md` в проекте

---

## Вопросы и поддержка

При возникновении вопросов обращайтесь к бэкенд-разработчику или архитектору проекта.


# ‚úÖ –≠–¢–ê–ü 3: LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (GIGACHAT) - –ó–ê–í–ï–†–®–ï–ù

## üéâ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. ‚úÖ LLMService - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–§–∞–π–ª:** `maps/services/llm_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

#### `_get_access_token()`
- –ü–æ–ª—É—á–µ–Ω–∏–µ OAuth —Ç–æ–∫–µ–Ω–∞ –¥–ª—è GIGACHAT API
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `https://ngw.devices.sberbank.ru:9443/api/v2/oauth`
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏

#### `_call_gigachat(prompt, system_prompt)`
- –í—ã–∑–æ–≤ GIGACHAT API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

#### `generate_schema(category_name, category_description)`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON-—Å—Ö–µ–º—ã –∞–Ω–∫–µ—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ POI
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–µ–π —Å —Ç–∏–ø–∞–º–∏: boolean, range, select, photo
- –£—á–µ—Ç –≤–µ—Å–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–ª–∏—è–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ö–µ–º—É —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

#### `analyze_review(review_text, poi_category)`
- –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞ —á–µ—Ä–µ–∑ LLM
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –æ–±—ä–µ–∫—Ç–∞
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞ (-1 –¥–æ 1)
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –∞–Ω–∫–µ—Ç—ã
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

#### `check_sentiment_consistency(review_text, rating)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –æ—Ü–µ–Ω–∫–∏
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–π –æ—Ü–µ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞
- –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö

### 2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ settings.py
- `GIGACHAT_CLIENT_ID` - ID –∫–ª–∏–µ–Ω—Ç–∞
- `GIGACHAT_CLIENT_SECRET` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
- `GIGACHAT_SCOPE` - Scope –¥–æ—Å—Ç—É–ø–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `GIGACHAT_API_PERS`)
- `GIGACHAT_MODEL` - –ú–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `GigaChat`)

### 3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ logger
- Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç—ã—Ö/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ —Å–±–æ—è—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è JSON –æ—Ç–≤–µ—Ç–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### 4. ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ access token
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è (expires_in)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- –ó–∞–ø–∞—Å –≤ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç—ã

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã –∞–Ω–∫–µ—Ç—ã
```
LLMService.generate_schema()
  ‚Üí –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç GIGACHAT API
  ‚Üí –ü–∞—Ä—Å–∏—Ç JSON –æ—Ç–≤–µ—Ç
  ‚Üí –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ö–µ–º—ã
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
```

### –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–∞
```
LLMService.analyze_review()
  ‚Üí –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–∞–∫—Ç—ã –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –æ–±—ä–µ–∫—Ç–∞
  ‚Üí –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç
  ‚Üí –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞
```
LLMService.check_sentiment_consistency()
  ‚Üí –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É —Ç–µ–∫—Å—Ç–∞
  ‚Üí –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –æ—Ü–µ–Ω–∫–æ–π (1-5)
  ‚Üí –í—ã—è–≤–ª—è–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```bash
GIGACHAT_CLIENT_ID=your-client-id
GIGACHAT_CLIENT_SECRET=your-client-secret
GIGACHAT_SCOPE=GIGACHAT_API_PERS
GIGACHAT_MODEL=GigaChat
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```python
from maps.services.llm_service import LLMService

llm = LLMService()

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã
schema = llm.generate_schema("–ê–ø—Ç–µ–∫–∞", "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∞–ø—Ç–µ–∫–∞")

# –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–∞
analysis = llm.analyze_review("–£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –Ω–æ–≤—ã–µ —Å—Ç–µ–ª–ª–∞–∂–∏", "–ê–ø—Ç–µ–∫–∞")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞
consistency = llm.check_sentiment_consistency("–û—Ç–ª–∏—á–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω!", 5)
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] LLMService –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –í—Å–µ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–¥–∞–ª–µ–Ω—ã
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [x] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- [x] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ settings.py
- [x] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**–≠–¢–ê–ü 4: API –∏ —Å–∏–≥–Ω–∞–ª—ã**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- –°–∏–≥–Ω–∞–ª—ã Django –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Å—Ö–µ–º –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è LLM –≤ –ø—Ä–æ—Ü–µ—Å—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-12-06
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è —Ä–∞–±–æ—Ç—ã LLM —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ GIGACHAT API –∫–ª—é—á–µ–π –≤ `.env` —Ñ–∞–π–ª–µ.

